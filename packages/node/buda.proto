syntax = "proto3";
package buda;

message Uuid {
	string id = 1;
}

message Timestamp {
	int64 seconds = 1;
	int32 nanos = 2;
}

message Funnel {
	message TagsEntry {
		string key = 1;
		string value = 2;
	}
	Uuid id = 1;
	Uuid user_id = 2;
	Timestamp created_at = 3;
	string name = 4;
	repeated TagsEntry tags = 5;
}

message Link {
	string target = 1;
	Uuid target_id = 2;
}

message FunnelEvent {
	message TagsEntry {
		string key = 1;
		string value = 2;
	}
	Uuid id = 1;
	Uuid funnel_id = 2;
	Uuid funnel_step_id = 3;
	Uuid user_id = 4;
	Timestamp created_at = 5;
	repeated TagsEntry tags = 6;
	bool funnel_end = 16;
	repeated Link links = 17;
}

enum PaymentSchedule{
	MONTHLY = 0;
	QUARTERLY = 1;
	BIANNUALLY = 2;
	ANNUALLY = 3;
}

enum PaymentTerms{
	DUE_UPON_RECEIPT = 0;
	NET_30 = 1;
	NET_60 = 2;
}

enum PaymentType{
	STRIPE = 0;
	APPLE = 1;
	ANDROID = 2;
	CHECK = 3;
	BANK = 4;
	PAYPAL = 5;
}

message Signup {
	Uuid id = 1;
	Uuid user_id = 2;
	Uuid visitor_id = 3;
	Uuid legacy_visitor_id = 100;
	Timestamp created_at = 4;
}

message SubscriptionCancelled {
	Uuid id = 1;
	Uuid subscription_id = 2;
	Uuid user_id = 3;
	Timestamp created_at = 4;
}

enum SubscriptionStatus{
	TRIALING = 0;
	ACTIVE = 1;
	PAST_DUE = 2;
	CANCELED = 3;
	EXPIRED = 4;
}

message SubscriptionCreated {
	message Subscription {
		Uuid id = 1;
		SubscriptionStatus status = 2;
		Timestamp created_at = 3;
		Uuid plan_id = 4;
		string plan_name = 5;
		string gateway_customer_id = 6;
		PaymentTerms payment_terms = 7;
		PaymentSchedule payment_schedule = 8;
		float term_value = 9;
		Timestamp initial_period_start = 10;
		Timestamp initial_period_end = 11;
	}
	message Payment {
		Uuid id = 1;
		PaymentType payment_type = 2;
		float payment_amount = 3;
		string payment_currency = 4;
	}
	Uuid id = 1;
	Uuid user_id = 2;
	Timestamp created_at = 3;
	Subscription subscription = 4;
	Payment payment = 5;
}

message SubscriptionPeriodUpdated {
	message Subscription {
		Uuid id = 1;
		SubscriptionStatus status = 2;
		Timestamp new_period_start = 3;
		Timestamp new_period_end = 4;
	}
	message Payment {
		Uuid id = 1;
		PaymentType payment_type = 2;
		float payment_amount = 3;
		string payment_currency = 4;
	}
	Uuid id = 1;
	Uuid user_id = 2;
	Timestamp created_at = 3;
	Subscription subscription = 4;
	Payment payment = 5;
}

message Visit {
	message UserAgent {
		string browser = 1;
		string version = 2;
	}
	message Utm {
		string source = 1;
		string medium = 2;
		string campaign = 3;
		string content = 4;
		string term = 5;
	}
	Uuid id = 1;
	Uuid visitor_id = 2;
	Uuid user_id = 3;
	Timestamp created_at = 4;
	string uri = 5;
	string ip = 6;
	Utm utm = 7;
	UserAgent user_agent = 8;
	string referrer = 9;
}

message Response {
	string message = 1;
}

service EventsCollector {
	rpc CollectFunnel (Funnel) returns (Response){}
	rpc CollectFunnelEvent (FunnelEvent) returns (Response){}
	rpc CollectVisit (Visit) returns (Response){}
	rpc CollectSignup (Signup) returns (Response){}
	rpc CollectSubscriptionCreated (SubscriptionCreated) returns (Response){}
	rpc CollectSubscriptionPeriodUpdated (SubscriptionPeriodUpdated) returns (Response){}
	rpc CollectSubscriptionCancelled (SubscriptionCancelled) returns (Response){}
}